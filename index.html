<html>

	<head>
		<!-- CSS -->
		<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.6/css/jquery.dataTables.css">
		
		<!-- JS -->
		<script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
		<script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" language="javascript" src="date.js"></script>
		
		<!-- JS Logic -->
		<script type="text/javascript" class="init">

			//variables
			var feedToTable = [];
			
			//helper function
			var obj2array = function(obj) {
				return Object.keys(obj).map(function (key) {return obj[key]});
			};
			
			//helper function
			var convertDate = function(date) {
			
				if(date==null)
					return "";
			
				return new Date(date).toString("yyyy-MM-dd");
			};
		
			//helper function
			var roundToTwo = function(num) {    
				return +(Math.round(num + "e+2")  + "e-2");
			}

			//helper function
			var drawLayer4Table = function() {
			
				$('#demo').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="example"></table>' );
			 
				$('#example').dataTable( {
					"data": feedToTable,
					"columns": [
						{ "title": "Claim Number" },
						{ "title": "Claim Status" },
						{ "title": "District" },
						{ "title": "Issue Date" },
						{ "title": "Cancelled Date" },
						{ "title": "Recorded Date" },
						{ "title": "Anniversary Date" },
						{ "title": "Area (Ha)" },
						{ "title": "Owner Name" },
						{ "title": "Claim Name" }
					]
				} );
			};
			
			//load layers
			var loadLayer4 = function() {
				$.ajax({
					type: 'GET',
					dataType: "jsonp",
					timeout: 60000,
					url: "http://www.mapconnect.com/arcgis/rest/services/test/nms/MapServer/4/query?text=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&objectIds=&where=1%3D1&time=&returnCountOnly=false&returnIdsOnly=false&returnGeometry=false&maxAllowableOffset=&outSR=&outFields=CLAIM_NUM%2CCLAIM_STAT%2CDISTRICT%2CISSUE_DATE%2CLAPSE_DATE%2CRECORD_DT%2CANNIV_DT%2CCLAIM_ACRE%2COWNERS%2CCLAIM_NAME&f=pjson",
					success: function (responseData, textStatus, jqXHR) {
						
						//extract the "attributes" Object
						featuresResponse = responseData.features;
						
						//convert dates
						featuresResponse.forEach(function(obj){obj.attributes.ISSUE_DATE=convertDate(obj.attributes.ISSUE_DATE)})
						featuresResponse.forEach(function(obj){obj.attributes.LAPSE_DATE=convertDate(obj.attributes.LAPSE_DATE)})
						featuresResponse.forEach(function(obj){obj.attributes.RECORD_DT=convertDate(obj.attributes.RECORD_DT)})
						featuresResponse.forEach(function(obj){obj.attributes.ANNIV_DT=convertDate(obj.attributes.ANNIV_DT)})
						
						//round area
						featuresResponse.forEach(function(obj){obj.attributes.CLAIM_ACRE=roundToTwo(obj.attributes.CLAIM_ACRE)})
						
						//convert each attribute object to an array and push into feedToTable
						featuresResponse.forEach(function(arr){feedToTable.push(obj2array(arr.attributes))})
											
						//re-draw table
						drawLayer4Table(); 
					},
					error: function (responseData, textStatus, errorThrown) {
						alert('failed');
					}
				});
			}
			
			//show a default layer
			loadLayer4();
			
			//the datatable
			$(document).ready(function() {
				drawLayer4Table();
			} );
		
		</script>
		
	</head>
	
	<body>
	
		<!-- Label -->
		<strong>
			<label for="cboLayers" id="lblLayers">Layers:</label>
		</strong>
		
		<!-- Dropdown -->
		<select id="cboLayers" name="cboLayers">
			<option value="layer4">Mineral Claim - Active</option>
			<option value="layer5">Mineral Claim - Pending</option>
		</select>

		
		<p/>
		
		<!-- DataTable Div -->
		<div id="demo">
	
	</body>

</html>